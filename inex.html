<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deer - Поиск и публикации</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
        .hidden { display: none; }
        #tabs-wrapper { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        #tabs-wrapper::-webkit-scrollbar { display: none; }
        .tab { transition: background-color 150ms, border-color 150ms; border-color: transparent; background-color: rgba(229, 231, 235, 0.5); }
        .dark .tab { background-color: rgba(75, 85, 99, 0.5); }
        .tab.active { background-color: #F9FAFB; border-color: #E5E7EB; z-index: 10; }
        .dark .tab.active { background-color: #1F2937; border-color: #374151; }
        .nav-btn { background-color: #e5e7eb; color: #4b5563; flex-shrink: 0; }
        .dark .nav-btn { background-color: #4b5563; color: #e5e7eb; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .post-like-btn.liked, .post-dislike-btn.disliked { color: #3b82f6; } /* blue-500 */
        #game-canvas { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; }
        .dark #game-canvas { background-color: #1f2937; border-color: #4b5563; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col min-h-screen">

    <!-- Browser Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md flex-shrink-0">
        <div class="w-full max-w-screen-xl mx-auto p-2 pb-0 flex items-end space-x-1">
            <button id="scroll-tabs-left" class="nav-btn p-0.5 rounded-full self-center hidden"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 19l-7-7 7-7" /></svg></button>
            <div id="tabs-wrapper" class="flex-grow flex items-end">
                <div id="tabs-container" class="flex flex-nowrap items-end"></div>
                <button id="add-tab-btn" class="p-1 rounded-full self-end mb-px hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0 ml-1"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v16m8-8H4" /></svg></button>
            </div>
            <button id="scroll-tabs-right" class="nav-btn p-0.5 rounded-full self-center hidden"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5l7 7-7 7" /></svg></button>
        </div>
        <div class="w-full max-w-screen-xl mx-auto p-2 pt-0 flex items-center space-x-2">
            <div class="flex items-center space-x-1 sm:space-x-3 text-gray-500">
                <button id="back-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"></path></svg></button>
                <button id="forward-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg></button>
                <button id="reload-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h5M20 20v-5h-5M20 4v5h-5M4 20v-5h5"></path></svg></button>
            </div>
            <form id="address-bar-form" class="flex-grow relative">
                <div class="absolute top-1/2 left-3 -translate-y-1/2 text-gray-400"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                <input type="text" id="address-bar-input" class="w-full bg-gray-200 dark:bg-gray-700 rounded-full py-1.5 pl-10 pr-4" placeholder="Поиск в Google или введите адрес">
            </form>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-start p-4 pt-6 sm:pt-10">
        <div id="main-content-area" class="w-full max-w-4xl mx-auto text-center"></div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-xs flex-shrink-0 shadow-inner">
        <div class="w-full max-w-screen-xl mx-auto p-3 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
             <div class="flex flex-wrap justify-center items-center gap-x-3 gap-y-1">
                <button data-modal-type="privacy" class="modal-trigger hover:text-blue-500">Конфиденциальность</button>
                <button data-modal-type="terms" class="modal-trigger hover:text-blue-500">Условия</button>
                <button data-modal-type="services" class="modal-trigger hover:text-blue-500">Сервисы</button>
                <button id="add-content-button" class="flex items-center gap-1 hover:text-blue-500">Добавить</button>
                <a href="https://youtube.com/@kit_0ficiall?si=R_UJa_YOq-WS1ipn" target="_blank" class="hover:text-blue-500">Разработчик</a>
            </div>
            <div class="flex items-center space-x-3">
                <button id="smile-ai-btn" class="hidden font-semibold text-purple-500 hover:underline">Smile AI</button>
                <button id="subscription-btn" class="font-semibold text-blue-600 dark:text-blue-400 hover:underline">Подписки</button>
                <div class="flex items-center" title="Ваши Deercoins"><span id="deercoin-balance" class="font-bold text-base">0</span><svg viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 ml-1 text-blue-500"><path d="M12.74,1.33C12.38,1.12,11.62,1.12,11.26,1.33L3.2,5.83C2.88,6.02,2.25,6.6,2.25,7.02v9.96c0,0.42,0.63,1,0.95,1.19l8.06,4.5c0.36,0.2,1.12,0.2,1.48,0l8.06-4.5c0.32-0.19,0.95-0.77,0.95-1.19V7.02c0-0.42-0.63-1-0.95-1.19L12.74,1.33z"/></svg></div>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="generic-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-2xl mx-auto max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h2 id="generic-modal-title" class="text-2xl font-bold"></h2><button class="modal-close p-1 rounded-full">&times;</button></div>
            <div id="generic-modal-body" class="prose dark:prose-invert max-w-none text-left"></div>
        </div>
    </div>
    
    <div id="add-post-modal-container"></div>
    
    <!-- Templates -->
    <template id="search-page-template"><div class="search-section"><div class="flex items-center justify-center mb-6"><svg viewBox="0 0 24 24" fill="currentColor" class="h-14 w-14 sm:h-16 md:h-20 mr-4 text-blue-500"><path d="M12.74,1.33C12.38,1.12,11.62,1.12,11.26,1.33L3.2,5.83C2.88,6.02,2.25,6.6,2.25,7.02v9.96c0,0.42,0.63,1,0.95,1.19l8.06,4.5c0.36,0.2,1.12,0.2,1.48,0l8.06-4.5c0.32-0.19,0.95-0.77,0.95-1.19V7.02c0-0.42-0.63-1-0.95-1.19L12.74,1.33z"/></svg><h1 class="text-5xl sm:text-6xl md:text-7xl font-bold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-indigo-600">Deer</h1></div><form class="search-form relative mb-4 max-w-2xl mx-auto"><div class="absolute top-1/2 left-4 -translate-y-1/2 text-gray-400"><button id="image-search-btn-main" type="button" title="Поиск по картинке"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg></button></div><input type="text" class="search-input w-full pl-14 pr-4 bg-white dark:bg-gray-800 border-2 rounded-full py-3" placeholder="Поиск..."></form><div class="search-categories flex justify-center items-center space-x-2 sm:space-x-6 border-b mb-6"><button data-search-type="web" class="search-tab font-semibold py-2 px-2 sm:px-0 border-b-2">Все</button><button data-search-type="images" class="search-tab font-semibold py-2 px-2 sm:px-0 border-b-2">Картинки</button><button data-search-type="videos" class="search-tab font-semibold py-2 px-2 sm:px-0 border-b-2">Видео</button></div><div class="flex items-center justify-center space-x-2 sm:space-x-4"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Поиск Deer</button><button type="button" class="lucky-button bg-gray-200 dark:bg-gray-700 font-semibold py-2 px-6 rounded-lg">Мне повезёт!</button></div></div></template>
    <template id="local-results-template"> <div class="local-search-results w-full text-left"><form class="results-search-form relative mb-6 max-w-2xl mx-auto"><div class="absolute top-1/2 left-4 -translate-y-1/2 text-gray-400"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div><input type="text" class="results-search-input w-full pl-12 pr-4 bg-white dark:bg-gray-700 border-2 rounded-full py-2.5" placeholder="Новый поиск..."></form><div class="results-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div></div></template>
    <template id="post-card-template"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col"><div class="post-image-wrapper w-full h-40 bg-gray-200 dark:bg-gray-700"></div><div class="p-3 flex-grow flex flex-col"><p class="font-semibold truncate flex-grow post-description"></p><div class="flex items-center justify-between text-xs text-gray-500 mt-2"><div class="flex items-center gap-1"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg><span class="post-views">0</span></div><div class="flex items-center gap-2"><button class="post-like-btn flex items-center gap-1"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-2.093 4.185-2.093-4.185A2 2 0 006.085 3H6a2 2 0 00-2 2v5h4l2 4 2-4h4z" /></svg><span class="post-likes">0</span></button><button class="post-dislike-btn flex items-center gap-1"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.738 3h4.017c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.085a2 2 0 001.736-.97l2.093-4.185 2.093 4.185A2 2 0 0017.915 21H18a2 2 0 002-2v-5h-4l-2-4-2 4h-4z" /></svg><span class="post-dislikes">0</span></button></div></div><button class="post-comment-btn text-xs text-blue-600 mt-2 text-left hover:underline">Комментарии (0)</button></div></div></template>
    <template id="add-post-modal-template"><div id="add-content-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-lg mx-auto"><h2 class="text-2xl font-bold mb-4">Создать публикацию</h2><form id="post-form"><div class="mb-4"><label for="post-description" class="block text-sm font-medium mb-1">Описание</label><textarea id="post-description" rows="4" class="w-full p-2 border rounded-md" required></textarea></div><div class="mb-4"><label for="post-photo" class="block text-sm font-medium mb-1">Фото</label><input type="file" id="post-photo" accept="image/*" class="w-full text-sm"></div><div class="mb-6"><label for="post-video" class="block text-sm font-medium mb-1">Видео</label><input type="file" id="post-video" accept="video/*" class="w-full text-sm"></div><div class="flex justify-end space-x-4"><button type="button" class="post-modal-close bg-gray-300 font-semibold py-2 px-4 rounded-lg">Отмена</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Опубликовать</button></div></form></div></div></template>
    <template id="game-container-template"><div class="game-container w-full flex flex-col items-center"><h2 class="game-title text-3xl font-bold mb-4"></h2><canvas id="game-canvas" width="600" height="400"></canvas><p class="game-instructions mt-4 text-sm text-gray-500"></p><button class="back-to-game-menu-btn mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg">← В Игровой Центр</button></div></template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DOMElements = { body: document.body, tabsWrapper: document.getElementById('tabs-wrapper'), tabsContainer: document.getElementById('tabs-container'), scrollTabsLeftBtn: document.getElementById('scroll-tabs-left'), scrollTabsRightBtn: document.getElementById('scroll-tabs-right'), addTabBtn: document.getElementById('add-tab-btn'), addressBarForm: document.getElementById('address-bar-form'), addressBarInput: document.getElementById('address-bar-input'), reloadBtn: document.getElementById('reload-btn'), backBtn: document.getElementById('back-btn'), forwardBtn: document.getElementById('forward-btn'), mainContentArea: document.getElementById('main-content-area'), footer: document.querySelector('footer'), deercoinBalance: document.getElementById('deercoin-balance'), smileAiBtn: document.getElementById('smile-ai-btn'), genericModal: document.getElementById('generic-modal'), addPostModalContainer: document.getElementById('add-post-modal-container'), searchPageTemplate: document.getElementById('search-page-template'), localResultsTemplate: document.getElementById('local-results-template'), postCardTemplate: document.getElementById('post-card-template'), addPostModalTemplate: document.getElementById('add-post-modal-template'), gameContainerTemplate: document.getElementById('game-container-template') };
        let appState = { userPosts: [], tabs: [], activeTabId: null, deerCoins: 0, lastLogin: null, subscription: 'none', currentGame: null };
        const STORAGE_KEYS = { posts: 'deer-posts-v10', tabs: 'deer-tabs-v10', activeTab: 'deer-active-tab-v10', coins: 'deer-coins-v10', lastLogin: 'deer-last-login-v10', subscription: 'deer-subscription-v10', freeSubGiven: 'deer-free-sub-v10', runnerHighScore: 'deer-runner-hs-v10' };

        const createNewTab = (makeActive = true) => { const newTab = { id: Date.now(), title: 'Новая вкладка', history: [{type: 'search', query: '', category: 'web'}], historyIndex: 0 }; appState.tabs.push(newTab); if (makeActive) appState.activeTabId = newTab.id; render(); };
        const closeTab = (id) => { if (appState.tabs.length > 1) { const i = appState.tabs.findIndex(t => t.id === id); appState.tabs.splice(i, 1); if (appState.activeTabId === id) appState.activeTabId = appState.tabs[Math.max(0, i - 1)].id; render(); } };
        const setActiveTab = (id) => { if (appState.activeTabId !== id) { appState.activeTabId = id; render(); } };
        const saveState = () => { try { Object.keys(STORAGE_KEYS).forEach(key => { if(appState[key] !== undefined && key !== 'currentGame' && STORAGE_KEYS[key]) localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appState[key]))}); } catch (e) { console.error("Failed to save state:", e); } };
        const loadState = () => {
            try {
                appState.userPosts = JSON.parse(localStorage.getItem(STORAGE_KEYS.posts) || '[]');
                appState.tabs = JSON.parse(localStorage.getItem(STORAGE_KEYS.tabs) || '[]');
                appState.activeTabId = JSON.parse(localStorage.getItem(STORAGE_KEYS.activeTab));
                appState.deerCoins = parseInt(JSON.parse(localStorage.getItem(STORAGE_KEYS.coins)) || '0');
                appState.lastLogin = JSON.parse(localStorage.getItem(STORAGE_KEYS.lastLogin));
                appState.subscription = JSON.parse(localStorage.getItem(STORAGE_KEYS.subscription)) || 'none';
                if (!localStorage.getItem(STORAGE_KEYS.freeSubGiven)) { appState.subscription = 'creator'; localStorage.setItem(STORAGE_KEYS.freeSubGiven, 'true'); }
                if (!appState.tabs.length || !appState.tabs.some(t => t.id === appState.activeTabId)) { appState.tabs = []; appState.activeTabId = null; createNewTab(); }
            } catch { appState.tabs = []; createNewTab(); }
        };
        const dailyCoinCheck = () => { const today = new Date().toDateString(); if (appState.lastLogin !== today) { appState.deerCoins += 10; appState.lastLogin = today; } };

        const pushToHistory = (entry) => { const tab = appState.tabs.find(t => t.id === appState.activeTabId); if(!tab) return; tab.history.length = tab.historyIndex + 1; tab.history.push(entry); tab.historyIndex++; };
        const navigateHistory = (direction) => { const tab = appState.tabs.find(t => t.id === appState.activeTabId); if(!tab) return; const newIndex = tab.historyIndex + direction; if(newIndex >= 0 && newIndex < tab.history.length) { tab.historyIndex = newIndex; render(); } };

        const render = () => { if(appState.currentGame) return; renderTabs(); renderMainContent(); renderFooter(); renderHeader(); saveState(); setTimeout(checkTabOverflow, 0); };
        const renderTabs = () => { DOMElements.tabsContainer.innerHTML = ''; appState.tabs.forEach(tab => { const isActive = tab.id === appState.activeTabId; const tabEl = document.createElement('div'); tabEl.className = `tab flex-shrink-0 flex items-center border-t border-l border-r rounded-t-lg px-2 sm:px-4 py-2 -mb-px relative cursor-pointer ${isActive ? 'active' : ''}`; tabEl.dataset.tabId = tab.id; tabEl.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5 mr-2 text-blue-500 flex-shrink-0"><path d="M12.74,1.33C12.38,1.12,11.62,1.12,11.26,1.33L3.2,5.83C2.88,6.02,2.25,6.6,2.25,7.02v9.96c0,0.42,0.63,1,0.95,1.19l8.06,4.5c0.36,0.2,1.12,0.2,1.48,0l8.06-4.5c0.32-0.19,0.95-0.77,0.95-1.19V7.02c0-0.42-0.63-1-0.95-1.19L12.74,1.33z"/></svg><span class="font-semibold text-xs sm:text-sm truncate mr-2">${tab.title}</span> ${appState.tabs.length > 1 ? `<button data-tab-id-close="${tab.id}" class="close-tab-btn p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10 ml-auto"><svg class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>` : ''}`; DOMElements.tabsContainer.appendChild(tabEl); }); };
        const renderMainContent = () => { const activeTab = appState.tabs.find(tab => tab.id === appState.activeTabId); DOMElements.mainContentArea.innerHTML = ''; if (!activeTab || !activeTab.history[activeTab.historyIndex]) return; const currentView = activeTab.history[activeTab.historyIndex]; if (currentView.type === 'results') { const resultsNode = DOMElements.localResultsTemplate.content.cloneNode(true); resultsNode.querySelector('.results-search-input').value = currentView.query; const grid = resultsNode.querySelector('.results-grid'); const results = appState.userPosts.filter(p => p.description.toLowerCase().includes(currentView.query.toLowerCase())); results.forEach(post => grid.appendChild(createPostCard(post))); DOMElements.mainContentArea.appendChild(resultsNode); } else { const searchNode = DOMElements.searchPageTemplate.content.cloneNode(true); searchNode.querySelector('.search-input').value = currentView.query || ''; searchNode.querySelectorAll('.search-tab').forEach(btn => btn.classList.toggle('active', btn.dataset.searchType === currentView.category)); DOMElements.mainContentArea.appendChild(searchNode); } };
        const renderFooter = () => { DOMElements.deercoinBalance.textContent = appState.deerCoins; DOMElements.smileAiBtn.classList.toggle('hidden', appState.subscription !== 'premium' && appState.subscription !== 'creator'); };
        const renderHeader = () => { const tab = appState.tabs.find(t => t.id === appState.activeTabId); if(!tab) return; DOMElements.backBtn.disabled = tab.historyIndex <= 0; DOMElements.forwardBtn.disabled = tab.historyIndex >= tab.history.length - 1; };
        const createPostCard = (post) => { const card = DOMElements.postCardTemplate.content.cloneNode(true).firstElementChild; card.dataset.postId = post.id; const imgWrapper = card.querySelector('.post-image-wrapper'); if (post.photoDataUrl) imgWrapper.innerHTML = `<img src="${post.photoDataUrl}" class="w-full h-full object-cover">`; else imgWrapper.innerHTML = `<div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><p class="text-xs text-gray-500">Нет фото</p></div>`; card.querySelector('.post-description').textContent = post.description; card.querySelector('.post-views').textContent = post.views || 0; const likeBtn = card.querySelector('.post-like-btn'); const dislikeBtn = card.querySelector('.post-dislike-btn'); likeBtn.querySelector('span').textContent = post.likes || 0; dislikeBtn.querySelector('span').textContent = post.dislikes || 0; likeBtn.classList.toggle('liked', post.userInteraction === 'liked'); dislikeBtn.classList.toggle('disliked', post.userInteraction === 'disliked'); card.querySelector('.post-comment-btn').textContent = `Комментарии (${(post.comments || []).length})`; return card; };
        const checkTabOverflow = () => { const c = DOMElements.tabsWrapper, i = c.scrollWidth > c.clientWidth; DOMElements.scrollTabsLeftBtn.classList.toggle('hidden', !i); DOMElements.scrollTabsRightBtn.classList.toggle('hidden', !i); if(i) updateScrollButtons(); };
        const updateScrollButtons = () => { const c = DOMElements.tabsWrapper; DOMElements.scrollTabsLeftBtn.disabled = c.scrollLeft <= 0; DOMElements.scrollTabsRightBtn.disabled = c.scrollLeft >= c.scrollWidth - c.clientWidth - 1; };
        
        const modalContent = {
            privacy: { title: 'Конфиденциальность и Информация', body: `<h3>Кто мы?</h3><p>Мы — молодая инновационная компания <strong>KIK</strong>...</p><h3>Что это?</h3><p><strong>Deer</strong> — это симулятор многофункционального браузера...</p>`},
            terms: { title: 'Условия использования', body: `<h3>1. Общие положения</h3><p>Весь контент хранится локально...</p><h3>2. Deercoin</h3><p>Валюта Deercoin начисляется в качестве бонуса...</p>`},
            services: { title: 'Наши сервисы', body: `<h3>ИИ-помощник "Frog"</h3><a href="https://sahlly-28.github.io/Frog/" target="_blank" class="text-blue-500 hover:underline">Перейти &rarr;</a><h3 class="mt-4">Социальная сеть "TOKI"</h3><a href="https://sahlly-28.github.io/TOKI-/" target="_blank" class="text-blue-500 hover:underline">Перейти в TOKI &rarr;</a>`},
            minigames: { title: 'Игровой центр', body: `<p>Выберите игру. Доступ к некоторым играм зависит от подписки.</p><div class="grid grid-cols-2 gap-4 mt-4"><button data-game="rocket" class="game-btn bg-blue-200 dark:bg-blue-800 p-4 rounded-lg">Космическая ракета</button><button data-game="runner" class="game-btn bg-blue-200 dark:bg-blue-800 p-4 rounded-lg">Олень-Бегун</button><button data-game="flappy" class="game-btn bg-gray-200 p-4 rounded-lg" ${appState.subscription === 'none' ? 'disabled' : ''}>Летящий Олень (Стандарт+)</button><button data-game="snake" class="game-btn bg-gray-200 p-4 rounded-lg" ${appState.subscription === 'none' ? 'disabled' : ''}>Змейка (Стандарт+)</button></div>`},
            subscriptions: { title: 'Подписки', body: `<div class="grid md:grid-cols-3 gap-4 mt-4 text-center"><div class="border rounded-lg p-4"><h3>Стандарт</h3><p class="my-2"><b>Цена: 500 DC</b> <span class="line-through">750</span></p><ul class="text-left list-disc list-inside text-sm"><li>Доступ к играм</li></ul><button data-tier="standard" data-cost="500" class="buy-sub-btn mt-4 w-full bg-gray-500 text-white py-2 rounded-lg">Купить</button></div><div class="border-2 border-blue-500 rounded-lg p-4 relative"><h3>Премиум</h3><p class="my-2"><b>Цена: 1200 DC</b> <span class="line-through">1500</span></p><ul class="text-left list-disc list-inside text-sm"><li>Все из Стандарта</li><li>Помощник Smile AI</li><li>Бета-версии игр</li></ul><button data-tier="premium" data-cost="1200" class="buy-sub-btn mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Купить</button></div><div class="border rounded-lg p-4"><h3>Creator</h3><p class="my-2"><b>Цена: 3000 DC</b></p><ul class="text-left list-disc list-inside text-sm"><li>Все из Премиум</li><li>Загрузка своих игр</li></ul><button data-tier="creator" data-cost="3000" class="buy-sub-btn mt-4 w-full bg-purple-600 text-white py-2 rounded-lg">Купить</button></div></div>`},
            smile: { title: "Smile AI", body: `<div id="smile-chat-window" class="h-80 bg-gray-200 dark:bg-gray-700 rounded-lg p-2 flex flex-col"><div id="smile-chat-messages" class="flex-grow overflow-y-auto mb-2 flex flex-col"></div><form id="smile-chat-form" class="flex"><input id="smile-chat-input" class="w-full p-2 rounded-l-md" placeholder="Спросите что-нибудь..."><button type="submit" class="bg-purple-500 text-white px-4 rounded-r-md">=&gt;</button></form></div>`},
            comments: { title: "Комментарии", body: `<div id="comment-list" class="max-h-48 overflow-y-auto mb-4 pr-2"></div><form id="comment-form" class="flex"><input class="w-full p-2 border rounded-l-md" placeholder="Ваш комментарий..."><button type="submit" class="bg-blue-600 text-white px-4 rounded-r-md">Отправить</button></form>`}
        };
        const openModal = (type, context) => { const content = modalContent[type]; if (!content) return; const modalEl = DOMElements.genericModal; modalEl.querySelector('#generic-modal-title').textContent = content.title; modalEl.querySelector('#generic-modal-body').innerHTML = content.body; modalEl.classList.remove('hidden'); if(type === 'smile') initSmileAI(); if(type === 'comments') initComments(context.postId); if(type === 'subscriptions') updateSubscriptionButtons(); };
        const openPostModal = () => { if (!document.getElementById('add-content-modal')) { DOMElements.addPostModalContainer.innerHTML = DOMElements.addPostModalTemplate.innerHTML; }};
        const updateSubscriptionButtons = () => { const tiers = {none: 0, standard: 1, premium: 2, creator: 3}; const userLevel = tiers[appState.subscription]; document.querySelectorAll('.buy-sub-btn').forEach(btn => { const btnLevel = tiers[btn.dataset.tier]; if(btnLevel <= userLevel) { btn.disabled = true; btn.textContent = "Куплено"; btn.classList.add('opacity-50'); } }); };
        
        const GameEngine = {
            rocket: { title: 'Космическая ракета', instructions: 'Стрелки влево/вправо для движения.', init(canvas, ctx) { let player = { x: canvas.width / 2 - 25, y: canvas.height - 60, width: 30, height: 50, lives: 3, speed: 5 }; let meteorites = []; let powerups = []; let frame = 0; let score = 0; let keys = {}; function gameLoop() { if(appState.currentGame !== 'rocket') return; ctx.clearRect(0, 0, canvas.width, canvas.height); if (keys.ArrowLeft && player.x > 0) player.x -= player.speed; if (keys.ArrowRight && player.x < canvas.width - player.width) player.x += player.speed; ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.moveTo(player.x + player.width/2, player.y); ctx.lineTo(player.x, player.y + player.height); ctx.lineTo(player.x + player.width, player.y + player.height); ctx.closePath(); ctx.fill(); if (frame % 30 === 0) meteorites.push({ x: Math.random() * canvas.width, y: -20, size: Math.random() * 20 + 10, speed: Math.random() * 2 + 2 }); if (frame % 500 === 0) powerups.push({ x: Math.random() * canvas.width, y: -20, size: 15, type: Math.random() > 0.5 ? 'life' : 'speed' }); meteorites.forEach((m, i) => { m.y += m.speed; ctx.fillStyle = 'gray'; ctx.fillRect(m.x, m.y, m.size, m.size); if (m.y > canvas.height) meteorites.splice(i, 1); if (player.x < m.x + m.size && player.x + player.width > m.x && player.y < m.y + m.size && player.y + player.height > m.y) { meteorites.splice(i, 1); player.lives--; if(player.lives <= 0) endGame('rocket'); } }); powerups.forEach((p, i) => { p.y += 2; ctx.fillStyle = p.type === 'life' ? 'red' : 'yellow'; ctx.fillRect(p.x, p.y, p.size, p.size); if (p.y > canvas.height) powerups.splice(i, 1); if (player.x < p.x + p.size && player.x + player.width > p.x && player.y < p.y + p.size && player.y + player.height > p.y) { powerups.splice(i, 1); if(p.type === 'life' && player.lives < 3) player.lives++; if(p.type === 'speed') { player.speed *= 1.5; setTimeout(() => player.speed /= 1.5, 5000); } } }); score++; frame++; ctx.fillStyle = '#000'; ctx.font = '20px Inter'; ctx.fillText(`Счет: ${score} | Жизни: ${'❤️'.repeat(player.lives)}`, 10, 20); requestAnimationFrame(gameLoop); } document.onkeydown = e => keys[e.code] = true; document.onkeyup = e => keys[e.code] = false; gameLoop(); } },
            runner: { title: 'Олень-Бегун', instructions: 'Нажми Пробел чтобы прыгнуть', init(canvas, ctx) { let deer = { x: 50, y: canvas.height - 40, width: 30, height: 40, vy: 0, onGround: true, shielded: false }; let obstacles = []; let birds = []; let powerups = []; let frame = 0; let score = 0; let gameSpeed = 4; let highScore = localStorage.getItem(STORAGE_KEYS.runnerHighScore) || 0; let gameStarted = false; function gameLoop() { if(appState.currentGame !== 'runner') return; if(!gameStarted) { ctx.fillStyle = '#000'; ctx.font = '24px Inter'; ctx.textAlign = 'center'; ctx.fillText('Нажмите Пробел для старта', canvas.width / 2, canvas.height / 2); return; } ctx.clearRect(0, 0, canvas.width, canvas.height); if (!deer.onGround) deer.vy += 0.8; deer.y += deer.vy; if (deer.y >= canvas.height - 40) { deer.y = canvas.height - 40; deer.vy = 0; deer.onGround = true; } ctx.fillStyle = deer.shielded ? 'rgba(100, 60, 20, 0.5)' : 'brown'; ctx.fillRect(deer.x, deer.y, deer.width, deer.height); ctx.fillRect(deer.x + 5, deer.y - 10, 5, 10); ctx.fillRect(deer.x + 20, deer.y - 10, 5, 10); if (frame % Math.max(20, 100 - score/10) === 0) obstacles.push({ x: canvas.width, width: 20, height: Math.random() * 30 + 20 }); if (frame % 250 === 0) birds.push({ x: canvas.width, y: canvas.height - 80, width: 30, height: 10 }); if (frame % 600 === 0) powerups.push({ x: canvas.width, y: canvas.height - 30, size: 15, type: Math.random() > 0.5 ? 'shield' : 'speed' }); obstacles.forEach((obs, i) => { obs.x -= gameSpeed; ctx.fillStyle = 'red'; ctx.fillRect(obs.x, canvas.height - obs.height, obs.width, obs.height); if(obs.x < -20) obstacles.splice(i, 1); if (!deer.shielded && deer.x < obs.x + obs.width && deer.x + deer.width > obs.x && deer.y + deer.height > canvas.height - obs.height) { endGame('runner', score); } }); birds.forEach((b, i) => { b.x -= gameSpeed * 1.2; ctx.fillStyle = 'black'; ctx.fillRect(b.x, b.y, b.width, b.height); if(b.x < -30) birds.splice(i, 1); if (!deer.shielded && deer.x < b.x + b.width && deer.x + deer.width > b.x && deer.y < b.y + b.height && deer.y + deer.height > b.y) { endGame('runner', score); } }); powerups.forEach((p, i) => { p.x -= gameSpeed; ctx.fillStyle = p.type === 'shield' ? 'blue' : 'yellow'; ctx.fillRect(p.x, p.y, p.size, p.size); if(p.x < -20) powerups.splice(i, 1); if (deer.x < p.x + p.size && deer.x + deer.width > p.x && deer.y < p.y + p.size && deer.y + deer.height > p.y) { powerups.splice(i, 1); if(p.type === 'shield') { deer.shielded = true; setTimeout(() => deer.shielded = false, 3000); } if(p.type === 'speed') { gameSpeed *= 1.5; setTimeout(() => gameSpeed /= 1.5, 3000); } }}); score++; frame++; ctx.textAlign = 'left'; ctx.fillStyle = '#000'; ctx.font = '20px Inter'; ctx.fillText(`Счет: ${score} | Рекорд: ${highScore}`, 10, 20); requestAnimationFrame(gameLoop); } function jump() { if(gameStarted && deer.onGround) { deer.vy = -15; deer.onGround = false; } else if (!gameStarted) { gameStarted = true; gameLoop(); } } document.onkeydown = e => { if (e.code === 'Space') e.preventDefault(); jump(); }; gameLoop(); } },
            flappy: { title: 'Летящий Олень', instructions: 'Нажми Пробел чтобы взлететь', init(canvas, ctx) { let deer = { x: 50, y: 150, width: 40, height: 30, vy: 0}; let pipes = []; let frame = 0; let score = 0; function gameLoop() { if(appState.currentGame !== 'flappy') return; ctx.clearRect(0,0,canvas.width, canvas.height); deer.vy += 0.4; deer.y += deer.vy; ctx.fillStyle = 'orange'; ctx.fillRect(deer.x, deer.y, deer.width, deer.height); if (frame % 90 === 0) { const h = Math.random() * 150 + 50; pipes.push({ x: canvas.width, y: 0, width: 50, height: h }); pipes.push({ x: canvas.width, y: h + 120, width: 50, height: canvas.height });} pipes.forEach((pipe, i) => { pipe.x -= 3; ctx.fillStyle = 'green'; ctx.fillRect(pipe.x, pipe.y, pipe.width, pipe.height); if(pipe.x < -50) { pipes.splice(i, 1); score++; } if (deer.x < pipe.x + pipe.width && deer.x + deer.width > pipe.x && deer.y < pipe.y + pipe.height && deer.y + deer.height > pipe.y) { endGame('flappy', score); } }); if(deer.y > canvas.height || deer.y < 0) endGame('flappy', score); frame++; ctx.fillStyle = '#000'; ctx.font = '20px Inter'; ctx.fillText(`Счет: ${score}`, 10, 20); requestAnimationFrame(gameLoop); } function flap() { deer.vy = -8; } document.onkeydown = e => { if(e.code === 'Space') { e.preventDefault(); flap(); } }; gameLoop(); } },
        };
        const launchGame = (gameId) => { const game = GameEngine[gameId]; if (!game) return; appState.currentGame = gameId; const activeTab = appState.tabs.find(t=>t.id === appState.activeTabId); pushToHistory({type: 'game', gameId: gameId}); const gameNode = DOMElements.gameContainerTemplate.content.cloneNode(true); gameNode.querySelector('.game-title').textContent = game.title; gameNode.querySelector('.game-instructions').textContent = game.instructions; DOMElements.mainContentArea.innerHTML = ''; DOMElements.mainContentArea.appendChild(gameNode); const canvas = document.getElementById('game-canvas'); const ctx = canvas.getContext('2d'); game.init(canvas, ctx); DOMElements.genericModal.classList.add('hidden'); };
        const endGame = (gameId, score) => { if(appState.currentGame !== gameId) return; if(gameId === 'runner') { const highScore = localStorage.getItem(STORAGE_KEYS.runnerHighScore) || 0; if (score > highScore) { localStorage.setItem(STORAGE_KEYS.runnerHighScore, score); alert(`Игра окончена! Новый рекорд: ${score}`); } else { alert(`Игра окончена! Счет: ${score}`); } } else { alert('Игра окончена! Счет: ' + score); } appState.currentGame = null; document.onkeydown = null; navigateHistory(-1); };

        const initSmileAI = () => { const messagesEl = document.getElementById('smile-chat-messages'); const form = document.getElementById('smile-chat-form'); const input = document.getElementById('smile-chat-input'); let chatHistory = []; const addMsg = (text, sender = 'ai') => { const msgEl = document.createElement('div'); msgEl.textContent = text; msgEl.className = `p-2 rounded-lg mb-2 max-w-[80%] ${sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-gray-300 dark:bg-gray-600 self-start'}`; messagesEl.appendChild(msgEl); messagesEl.scrollTop = messagesEl.scrollHeight; }; form.onsubmit = async (e) => { e.preventDefault(); const userMsg = input.value.trim(); if (!userMsg) return; addMsg(userMsg, 'user'); input.value = ''; const loadingEl = document.createElement('div'); loadingEl.textContent = '...'; loadingEl.className = 'p-2 rounded-lg mb-2 max-w-[80%] bg-gray-300 dark:bg-gray-600 self-start'; messagesEl.appendChild(loadingEl); messagesEl.scrollTop = messagesEl.scrollHeight; chatHistory.push({ role: "user", parts: [{ text: userMsg }] }); const payload = { contents: chatHistory }; const apiKey = "AIzaSyDdM4hDK3aGm-w4C-edflewPI7V_Fx8eSw"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if(!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); const aiMsg = result.candidates[0].content.parts[0].text; loadingEl.remove(); addMsg(aiMsg, 'ai'); chatHistory.push({ role: "model", parts: [{ text: aiMsg }] }); } catch(error) { loadingEl.remove(); addMsg(`Ошибка: ${error.message}. Не удалось связаться с ИИ.`, 'ai'); } }; };
        const initComments = (postId) => { const post = appState.userPosts.find(p => p.id === postId); if (!post) return; const commentList = document.getElementById('comment-list'); const commentForm = document.getElementById('comment-form'); const renderComments = () => { commentList.innerHTML = ''; (post.comments || []).forEach(comment => { const el = document.createElement('div'); el.className = 'p-2 border-b text-sm'; el.textContent = comment.text; commentList.appendChild(el); }); }; commentForm.onsubmit = (e) => { e.preventDefault(); const input = e.target.querySelector('input'); const text = input.value.trim(); if(text) { if(!post.comments) post.comments = []; post.comments.push({text: text}); input.value = ''; renderComments(); } }; renderComments(); };

        const handlePostSubmit = (e) => { e.preventDefault(); const form = e.target; const description = form.querySelector('#post-description').value.trim(); if (!description) { alert("Нужно описание."); return; } const post = { id: Date.now(), description, photoDataUrl: null, video: form.querySelector('#post-video').files[0]?.name || null, views: 0, likes: 0, dislikes: 0, comments: [], userInteraction: null }; const photoFile = form.querySelector('#post-photo').files[0]; const save = () => { appState.userPosts.unshift(post); saveState(); form.closest('#add-content-modal').remove(); }; if (photoFile) { if (photoFile.size > 5 * 1024 * 1024) { alert("Фото слишком большое (макс. 5 МБ)"); return; } const reader = new FileReader(); reader.onload = (e) => { post.photoDataUrl = e.target.result; save(); }; reader.readAsDataURL(photoFile); } else { save(); } };
        const handleInteraction = (e) => { const postCard = e.target.closest('[data-post-id]'); if (!postCard) return; const postId = parseInt(postCard.dataset.postId); const post = appState.userPosts.find(p => p.id === postId); if(!post) return; if (e.target.closest('.post-comment-btn')) { openModal('comments', {postId}); return; } const isLike = !!e.target.closest('.post-like-btn'); const isDislike = !!e.target.closest('.post-dislike-btn'); if (!isLike && !isDislike) return; const currentInteraction = post.userInteraction; if (isLike) { if(currentInteraction === 'liked') { post.likes--; post.userInteraction = null; } else { if(currentInteraction === 'disliked') post.dislikes--; post.likes++; post.userInteraction = 'liked'; } } else if (isDislike) { if(currentInteraction === 'disliked') { post.dislikes--; post.userInteraction = null; } else { if(currentInteraction === 'liked') post.likes--; post.dislikes++; post.userInteraction = 'disliked'; } } render(); };

        const setupEventListeners = () => {
            DOMElements.mainContentArea.addEventListener('submit', e => { if (e.target.matches('.search-form, .results-search-form')) { e.preventDefault(); const input = e.target.querySelector('input'); const activeTab = appState.tabs.find(t => t.id === appState.activeTabId); const query = input.value.trim(); if (!query || !activeTab) return; const results = appState.userPosts.filter(p => p.description.toLowerCase().includes(query.toLowerCase())); const currentCategory = activeTab.history[activeTab.historyIndex].category; if (results.length > 0 && currentCategory === 'web') { activeTab.title = query.slice(0, 15); pushToHistory({type: 'results', query: query}); render(); } else { const urls = { web: `https://www.bing.com/search?q=`, images: `https://www.bing.com/images/search?q=`, videos: `https://www.bing.com/videos/search?q=` }; window.location.href = (urls[currentCategory] || urls.web) + encodeURIComponent(query); } } });
            DOMElements.mainContentArea.addEventListener('click', e => { const activeTab = appState.tabs.find(t => t.id === appState.activeTabId); if (!activeTab) return; if (e.target.matches('.lucky-button')) openModal('minigames'); if (e.target.matches('.back-to-search-btn')) { navigateHistory(-1); } if (e.target.matches('.search-tab')) { activeTab.history[activeTab.historyIndex].category = e.target.dataset.searchType; render(); } handleInteraction(e); if (e.target.closest('#image-search-btn-main')) { alert('Поиск по картинке в разработке.'); const i = document.createElement('input'); i.type = 'file'; i.accept = 'image/*'; i.click(); }});
            DOMElements.addressBarForm.addEventListener('submit', e => { e.preventDefault(); const q = DOMElements.addressBarInput.value.trim(); if(q) window.location.href = (q.includes('.') && !q.includes(' ')) ? (q.startsWith('http') ? q : 'https://' + q) : `https://www.google.com/search?q=${encodeURIComponent(q)}`; });
            DOMElements.tabsWrapper.addEventListener('click', e => { const t = e.target.closest('.tab'), c = e.target.closest('.close-tab-btn'); if (c) { e.stopPropagation(); closeTab(parseInt(c.dataset.tabIdClose)); } else if (t) { setActiveTab(parseInt(t.dataset.tabId)); } });
            DOMElements.addTabBtn.addEventListener('click', () => createNewTab());
            DOMElements.scrollTabsLeftBtn.addEventListener('click', () => DOMElements.tabsWrapper.scrollBy({ left: -200, behavior: 'smooth' }));
            DOMElements.scrollTabsRightBtn.addEventListener('click', () => DOMElements.tabsWrapper.scrollBy({ left: 200, behavior: 'smooth' }));
            DOMElements.tabsWrapper.addEventListener('scroll', updateScrollButtons);
            DOMElements.footer.addEventListener('click', e => { const t = e.target.closest('.modal-trigger'); if (t) openModal(t.dataset.modalType); if (e.target.closest('#subscription-btn')) openModal('subscriptions'); if (e.target.closest('#add-content-button')) openPostModal(); if (e.target.closest('#smile-ai-btn')) openModal('smile'); });
            DOMElements.body.addEventListener('click', e => { if (e.target.matches('.modal-close') || e.target.id === 'generic-modal') DOMElements.genericModal.classList.add('hidden'); if (e.target.matches('.post-modal-close')) e.target.closest('#add-content-modal')?.remove(); if(e.target.matches('.buy-sub-btn')) { const cost = parseInt(e.target.dataset.cost); if (appState.deerCoins >= cost) { appState.deerCoins -= cost; appState.subscription = e.target.dataset.tier; render(); alert(`Поздравляем! Вы приобрели подписку "${e.target.dataset.tier}".`); DOMElements.genericModal.classList.add('hidden'); } else { alert('Недостаточно Deercoin!'); } } if(e.target.matches('.game-btn')) { launchGame(e.target.dataset.game); } if(e.target.matches('.back-to-game-menu-btn')) { openModal('minigames'); } });
            DOMElements.body.addEventListener('submit', e => { if (e.target.id === 'post-form') handlePostSubmit(e); });
            window.addEventListener('resize', checkTabOverflow);
            DOMElements.reloadBtn.addEventListener('click', () => { if(appState.currentGame) { endGame(appState.currentGame); } else { window.location.reload(); } });
            DOMElements.backBtn.addEventListener('click', () => navigateHistory(-1));
            DOMElements.forwardBtn.addEventListener('click', () => navigateHistory(1));
        };
        
        loadState();
        dailyCoinCheck();
        setupEventListeners();
        render();
    });
    </script>
</body>
</html>

